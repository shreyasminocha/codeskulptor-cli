#!/usr/bin/env bash

COMMAND="$1"
FILE="$2"
NAME="${3:-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 11 ; echo '')}"

OPTIND=4 # COMMAND, FILE, NAME, ...options
while getopts ':b:v:' option; do
    case "$option" in
        b)
            BUCKET="$OPTARG"
            ;;
        v)
            VERSION="$OPTARG"
            ;;
    esac
done

BUCKET="${BUCKET:-user305}"
BUCKET_URI="https://codeskulptor-${BUCKET}.commondatastorage.googleapis.com"

if [ -z ${VERSION+x} ]; then
    REMOTE_FILE="${BUCKET}_${NAME}.py"
else
    REMOTE_FILE="${BUCKET}_${NAME}_${VERSION}.py"
fi

download() {
    curl -s "$BUCKET_URI/$REMOTE_FILE" -o "$FILE"
}

upload() {
    # account identifier
    GOOGLE_ACCESS_ID='GOOGRDMQGVG37BVSPZX7XLQI'

    # base64-encoded JSON
    POLICY='eyJleHBpcmF0aW9uIjogIjIwMjEtMDEtMDFUMTI6MDA6MDAuMDAwWiIsCgogICJjb25kaXRpb25zIjogWwogICAgeyJidWNrZXQiOiAiY29kZXNrdWxwdG9yLXVzZXIzMDUifSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJGtleSIsICJ1c2VyMzA1Il0sCiAgICBbImVxIiwgIiRDb250ZW50LVR5cGUiLCAidGV4dC94LXB5dGhvbiJdLAogICAgWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsIDAsIDY1NTM2XQogIF0KfQo='

    # base64-encoded signature of the policy
    # created with a key associated with the account described by the access ID
    SIGNATURE='RuoMn36XzwRS97unY4JB/wLWjY0='

    # These form fields were lifted from the <form> on CodeSkulptor.
    # Should the values of those fields change, these would need to be updated.

    # See also: https://cloud.google.com/storage/docs/xml-api/post-object

    curl --fail -X POST \
        -F "key=$REMOTE_FILE" \
        -F 'Content-Type=text/x-python' \
        -F "GoogleAccessId=$GOOGLE_ACCESS_ID" \
        -F "Policy=$POLICY" \
        -F "Signature=$SIGNATURE" \
        -F "file=@$FILE" \
        "$BUCKET_URI"

    STATUS_CODE="$?"
    if [ "$STATUS_CODE" -eq 0 ]; then
        echo "https://py3.codeskulptor.org/#$REMOTE_FILE"
    else
        echo 'An error occurred while uploading the file'
        exit "$STATUS_CODE"
    fi
}

help_text() {
    cat << \EOT
NAME
    csk â€” CodeSkulptor unofficial CLI

DESCRIPTION
    csk is a CLI tool to upload files to and download files from CodeSkulptor.

USAGE
    csk SUBCOMMAND FILE [NAME] [OPTIONS]

SUBCOMMANDS
    u | upload		Upload files to CodeSkulptor

        The file (or STDIN if FILE is -), will be uploaded.
        A CodeSkulptor URL will be outputted to STDOUT.

    d | download	Download files from CodeSkulptor

        The file will be downloaded and saved to the path specified
        or outputted to STDOUT if FILE is -.

OPTIONS
    -b		[str]	Bucket ('user305' by default)
    -v		[int]	File version

EXAMPLES
    Download /#user305_U0CqjtUA8X_0.py:

        $ csk d file.py U0CqjtUA8X -v 0

    Download /#examples140_modimport.py:

        $ csk d file.py modimport -b examples140

    Output /#user305_U0CqjtUA8X_0.py to STDOUT:

        $ csk d - U0CqjtUA8X -v 0

    Upload example.py to a random name:

        $ csk u example.py
        https://py3.codeskulptor.org/#user305_Xo0qphJfsM2.py

    Upload example.py to /#user305_example_0.py:

        $ csk u example.py example -v 0
        https://py3.codeskulptor.org/#user305_example_0.py
EOT
}

case "$COMMAND" in
    d | dl | down | download)
        download
    ;;

    u | ul | up | upload)
        upload
    ;;

    help | -h | --help)
        help_text
    ;;

    * )
        echo "Invalid command '$COMMAND'"
        echo
        help_text
        exit 1
    ;;
esac
